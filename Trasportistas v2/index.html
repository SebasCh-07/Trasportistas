<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Plataforma Tours & Traslados - Login</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="shared/assets/styles.css" />
</head>
<body class="auth-page">
    <div class="auth-container">
        <div class="brand">
            <h1 id="brandTitle">Login</h1>
            <p class="subtitle" id="brandSubtitle">Accede para continuar</p>
        </div>

    <div class="tabs">
      <button class="tab active" id="tabLogin">Login</button>
      <button class="tab" id="tabRegister">Register</button>
    </div>
    <form id="loginForm" class="card" style="display:block;">
            <div class="form-row">
                <label for="email">Email</label>
                <input id="email" type="email" placeholder="tu@correo.com" required />
            </div>
            <div class="form-row">
                <label for="password">ContraseÃ±a</label>
                <input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required />
            </div>
            <button type="submit" class="btn primary w-100">Ingresar</button>
            <div id="loginError" class="alert error" style="display:none;">Credenciales invÃ¡lidas o rol incorrecto</div>
        </form>

        <form id="registerForm" class="card register-form" style="display:none; margin-top:12px;">
            <div class="register-layout">
                <div class="register-fields">
                    <div class="register-row">
                        <div class="form-row">
                            <label for="regNombres">NOMBRES</label>
                            <input id="regNombres" required />
                        </div>
                        <div class="form-row">
                            <label for="regApellidos">APELLIDOS</label>
                            <input id="regApellidos" required />
                        </div>
                    </div>
                    
                    <div class="register-row">
                        <div class="form-row">
                            <label for="regCI">CI</label>
                            <input id="regCI" required />
                        </div>
                        <div class="form-row">
                            <label for="regTelefono">TELEFONO</label>
                            <input id="regTelefono" required />
                        </div>
                    </div>
                    
                    <div class="register-row">
                        <div class="form-row address-field">
                            <label for="regDireccion">DIRECCION</label>
                            <input id="regDireccion" placeholder="Calle, nÃºmero, referencia" required />
                        </div>
                        <div class="form-row map-button">
                            <button type="button" id="openMap" class="btn map-btn">UBICAR EN MAPA</button>
                        </div>
                    </div>
                    
                    <div class="register-row">
                        <div class="form-row">
                            <label for="regEmail">CORREO</label>
                            <input id="regEmail" type="email" required />
                        </div>
                        <div class="form-row">
                            <label for="regPass">CONTRASEÃ‘A</label>
                            <input id="regPass" type="password" required />
                        </div>
                        <div class="form-row">
                            <label for="regPass2">CONFIRMAR CONTRASEÃ‘A</label>
                            <input id="regPass2" type="password" required />
                        </div>
                    </div>
                    
                </div>
                
                <div class="register-photo">
                    <div class="photo-container">
                        <div class="avatar-preview" id="avatarPreview">
                            <div class="photo-icon">ðŸ‘¤</div>
                        </div>
                        <label for="regFoto" class="photo-label">SUBIR FOTO</label>
                        <input id="regFoto" type="file" accept="image/*" style="display: none;" />
                    </div>
                </div>
            </div>
            
            <div class="register-actions">
                <button type="submit" class="btn primary w-100">Crear cuenta</button>
                <div id="registerMsg" class="alert info" style="display:none;"></div>
                <small class="muted" id="coordPreview"></small>
            </div>
        </form>

        <footer class="mini-footer">Â© <span id="year"></span> Tours & Traslados. Todos los derechos reservados.</footer>
    </div>

    <div class="modal-backdrop" id="mapBackdrop"></div>
    <div class="modal" id="mapModal">
      <div class="modal-content">
        <div class="modal-header">
          <strong>Selecciona tu ubicaciÃ³n</strong>
          <button id="closeMap" class="btn ghost" title="Cerrar">âœ–</button>
        </div>
        <div class="modal-body">
          <div class="map map-picker" id="mapPicker"></div>
        </div>
        <div class="modal-footer">
          <button class="btn ghost" id="cancelMap">Cancelar</button>
          <button class="btn primary" id="usePoint">Usar punto</button>
        </div>
      </div>
    </div>

    <script type="module">
        import { Auth, registerUser, notify } from './shared/assets/scripts.js';

        document.getElementById('year').textContent = new Date().getFullYear();

        // Tabs
        const tabLogin = document.getElementById('tabLogin');
        const tabRegister = document.getElementById('tabRegister');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        function setTab(tab) {
          const authContainer = document.querySelector('.auth-container');
          if (tab === 'login') {
            tabLogin.classList.add('active'); tabRegister.classList.remove('active');
            loginForm.style.display = 'block'; registerForm.style.display = 'none';
            authContainer.classList.remove('register-active');
            document.getElementById('brandTitle').textContent = 'Login';
            document.getElementById('brandSubtitle').textContent = 'Accede para continuar';
          } else {
            tabRegister.classList.add('active'); tabLogin.classList.remove('active');
            registerForm.style.display = 'block'; loginForm.style.display = 'none';
            authContainer.classList.add('register-active');
            document.getElementById('brandTitle').textContent = 'Register';
            document.getElementById('brandSubtitle').textContent = 'Crea tu cuenta';
          }
        }
        tabLogin.addEventListener('click', (e)=>{ e.preventDefault(); setTab('login'); });
        tabRegister.addEventListener('click', (e)=>{ e.preventDefault(); setTab('register'); });

        // Login
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;

            const result = Auth.login({ email, password });
            if (!result.success) {
                const el = document.getElementById('loginError');
                el.style.display = 'block';
                el.textContent = result.message || 'Error de autenticaciÃ³n';
                return;
            }

            const mapRoleToPath = {
                admin: 'admin/index.html',
                empresa: 'empresa/index.html',
                cliente: 'cliente/index.html',
                clienteEmpresa: 'clienteEmpresa/index.html',
                conductor: 'conductor/index.html',
            };
            window.location.href = mapRoleToPath[result.user.role];
        });

        // Registro
        let pickedPoint = null;
        const mapModal = document.getElementById('mapModal');
        const mapBackdrop = document.getElementById('mapBackdrop');
        const mapPicker = document.getElementById('mapPicker');
        function openMap() { mapModal.classList.add('show'); mapBackdrop.classList.add('show'); }
        function closeMap() { 
          mapModal.classList.remove('show'); 
          mapBackdrop.classList.remove('show'); 
          
          // Limpiar el mapa cuando se cierre el modal
          if (mapPickerInstance) {
            try {
              mapPickerInstance.remove();
              mapPickerInstance = null;
              mapPickerMarker = null;
              mapPicker.innerHTML = ''; // Limpiar completamente el contenedor
            } catch (error) {
              console.warn('Error al limpiar el mapa:', error);
              mapPickerInstance = null;
              mapPickerMarker = null;
              mapPicker.innerHTML = '';
            }
          }
        }
        document.getElementById('closeMap').onclick = closeMap;
        document.getElementById('cancelMap').onclick = closeMap;
        let mapPickerInstance = null; let mapPickerMarker = null;
        document.getElementById('openMap').addEventListener('click', async () => {
          openMap();
          
          // Esperar a que el modal se renderice completamente
          setTimeout(async () => {
            try {
              const { initLeafletMap, ensureLeaflet } = await import('./shared/assets/scripts.js');
              await ensureLeaflet();
              
              // Limpiar completamente el contenedor
              mapPicker.innerHTML = '';
              
              // Crear nueva instancia del mapa
              mapPickerInstance = await initLeafletMap(mapPicker, { center: [-0.1807, -78.4678], zoom: 12 });
              
              // Agregar evento de clic al mapa
              mapPickerInstance.on('click', (e) => {
                pickedPoint = { lat: e.latlng.lat, lng: e.latlng.lng };
                if (!mapPickerMarker) { 
                  mapPickerMarker = L.marker([pickedPoint.lat, pickedPoint.lng]).addTo(mapPickerInstance); 
                } else { 
                  mapPickerMarker.setLatLng([pickedPoint.lat, pickedPoint.lng]); 
                }
                document.getElementById('coordPreview').textContent = `Coordenadas seleccionadas: ${pickedPoint.lat.toFixed(5)}, ${pickedPoint.lng.toFixed(5)}`;
              });
            } catch (error) {
              console.error('Error al inicializar el mapa:', error);
              notify('Error al cargar el mapa. IntÃ©ntalo de nuevo.', 'error');
            }
          }, 150); // Aumentar el tiempo para asegurar que el modal estÃ© completamente visible
        });
        document.getElementById('usePoint').onclick = () => { closeMap(); };

        // Foto preview
        const regFoto = document.getElementById('regFoto');
        const avatarPreview = document.getElementById('avatarPreview');
        let fotoDataUrl = null;
        regFoto.addEventListener('change', () => {
          const file = regFoto.files?.[0]; if (!file) return;
          const reader = new FileReader();
          reader.onload = () => { fotoDataUrl = reader.result; avatarPreview.style.backgroundImage = `url('${fotoDataUrl}')`; };
          reader.readAsDataURL(file);
        });

        registerForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const roleEl = document.getElementById('regRole');
          const payload = {
            nombres: document.getElementById('regNombres').value.trim(),
            apellidos: document.getElementById('regApellidos').value.trim(),
            ci: document.getElementById('regCI').value.trim(),
            telefono: document.getElementById('regTelefono').value.trim(),
            direccion: document.getElementById('regDireccion').value.trim(),
            email: document.getElementById('regEmail').value.trim(),
            role: roleEl ? roleEl.value : 'cliente',
            password: document.getElementById('regPass').value,
            password2: document.getElementById('regPass2').value,
            location: pickedPoint,
            fotoDataUrl,
          };
          const msg = document.getElementById('registerMsg');
          msg.style.display = 'none';
          if (!payload.nombres || !payload.apellidos || !payload.ci || !payload.telefono || !payload.direccion || !payload.email || !payload.password || !payload.password2) {
            msg.style.display = 'block'; msg.className = 'alert error'; msg.textContent = 'Completa todos los campos'; return;
          }
          if (payload.password !== payload.password2) { msg.style.display = 'block'; msg.className = 'alert error'; msg.textContent = 'Las contraseÃ±as no coinciden'; return; }
          if (!payload.location) { msg.style.display = 'block'; msg.className = 'alert error'; msg.textContent = 'Selecciona tu ubicaciÃ³n en el mapa'; return; }
          const res = registerUser(payload);
          if (!res.success) { msg.style.display = 'block'; msg.className = 'alert error'; msg.textContent = res.message || 'Error en registro'; return; }
          msg.style.display = 'block'; msg.className = 'alert success'; msg.textContent = 'Cuenta creada. Ya puedes iniciar sesiÃ³n.';
          setTab('login');
        });
    </script>
</body>
</html>


